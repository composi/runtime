{"version":3,"file":"runtime.mjs.map","sources":["../src/runtime.js","../src/union.js","../src/effects.js"],"sourcesContent":["/**\n * @typedef {Object<string, any>} Message\n * @prop {string} type\n * @prop {any} [data]\n * @typedef {(msg?: Message | Function, data?: any) => Message} Send\n * @typedef {() => State} GetState\n */\n/**\n * @typedef {any} State Simple or complex types for application state.\n */\n/**\n * @typedef {State | void} InitResult Return result of program init method.\n */\n/**\n * @typedef {Object<string, any>} Program A program to run.\n * @prop {() => InitResult} init Method to set up initial state.\n * @prop {(state: State, send?: Send) => void} view Method to present the current application state.\n * @prop {(state: State, msg?: Message, send?: Send) => any} update Method to capture messages sent from view or subscriptions. According to the message, an action will transform application state and pass it the the program view method.\n * @prop {(send?: Send, getState?: GetState) => void} [subscriptions] Method to run effects when the program starts. These run independently from the rest of the program.\n * @prop {(send?: Send, getState?: GetState) => void} [subs] Shortcut for subscriptions.\n * @prop {(state: State) => void} [done] Method to do clean up when shutting down a program.\n * @prop {Send} [send] A static send function for dispatching message to a program. Used with routers and in composition.\n */\n/**\n * The @composi/runtime.\n * @example\n *\n * ```\n * // Create a runtime program\n * const program = {\n *   // Define state:\n *   init() {\n *     return [{count: 0}]\n *   },\n *   // Define view to render.\n *   // Notice event to send message 'incr'.\n *   view(state, send) {\n *      return render(<div onclick={send('incr')}>The count is: {state.count}</div>, document.body)\n *   },\n *   // Define action to update state:\n *   update(state, msg) {\n *     if (msg === 'incr') {\n *        return [state.count++]\n *     }\n *   }\n * }\n * // Run the program:\n * run(program)\n * ```\n * @param {Program} program A program to run with five methods: `init`, `view`, `update`, `subscriptions` and `done`.\n * @return {() => void} Function to terminate runtime.\n */\nexport function run(program) {\n  let init = program.init\n  const view = program.view\n  const update = program.update\n  const subscriptions = program.subscriptions || program.subs\n  const done = program.done\n  let state\n  let isRunning = true\n  let isFirstRun = true\n  const getState = () => state\n\n  /**\n   * Send a message.\n   * @param {Message} message\n   *\n   */\n  function send(message, data) {\n    let msg = message\n    /**\n     * message is a function from a tagged union that\n     * can be called to return a message object.\n     */\n    isRunning\n     && (typeof message === 'function') \n     && (msg = /** @type {Function} */ (message)(data))\n    \n    return isRunning &&\n      updateView(update(state, msg, send))\n  }\n\n  /**\n   * Expose send as static function on program object.\n   * This is to let you send messages to the program\n   * from other contexts, such as in a @composi/router action.\n   */\n  program['send'] = send\n\n  /**\n   * Handle changes to state and executing effects.\n   * @param {any} update\n   * @return {void} undefined\n   */\n  const updateView = update => {\n    update \n      ? state = update \n      : init \n      ? state = init() \n      : state = undefined\n\n    isFirstRun\n      && subscriptions\n      && typeof subscriptions === 'function'\n      && subscriptions(send, getState)\n\n    isFirstRun = false\n    \n    view(state, send)\n  }\n  updateView(state)\n\n  /**\n   * Function to end runtime.\n   * @return {void} undefined\n   */\n  return () => {\n    isRunning\n      && done\n      && done(state)\n      \n    isRunning = false\n  }\n}\n","/**\n * Helper function for testing whether message type exists on actions object.\n */\nconst hasOwnProperty = Object.prototype.hasOwnProperty\n\n/**\n * @typedef {Object} Tag\n * @prop {string} type\n * @prop {any} [data]\n */\n/**\n * @param {Tag} tag\n * @param {Object<string, Function>} handlers\n * @param {() => void} [catchAll]\n */\nfunction match(tag, handlers, catchAll) {\n  const {type, data} = tag\n  return type\n    ? (type => {\n      const match = hasOwnProperty.call(handlers, type) && handlers[type]\n      return match\n        ? match(data)\n        : catchAll\n        ? catchAll()\n        : console.error(\n          `The message you sent has no matching action method. Check the spelling for the message or the action method. The message type was \"${type}\".`\n        )\n    })(type)\n    : (() => {\n      console.error(\n        \"The message you provided was not valid. Messages have the format: {type: 'whatever', data?: 'something'}\"\n      )\n      console.error('The tag you provided was:')\n      console.dir(tag)\n    })()\n}\n\n/**\n * Create a union of string tags.\n * @param {string[]} types\n * @returns {Object<string, any>} Object\n */\nfunction createUnion(types) {\n  const variants = Object.create(null)\n\n  let idx = 0\n  while (idx < types.length) {\n    const type = types[idx]\n    type === 'match'\n      && console.error(\n        `The message type you provided was \"match\". This cannot be used since it would override the message union's own match method. Please change it to something else, such as \"matchName\", etc.`\n      )\n\n    variants[type] = data => ({ type, data })\n    idx++\n  }\n\n  return { variants, match }\n}\n\n/**\n * @typedef {Object} MessageUnion\n */\n\n/**\n * Create a union of types for matching up with functions. This is used to define actions for the `update` method of a runtime program.\n * @param {...string} types\n * @returns {MessageUnion} MessageUnion\n */\nexport function union(...types) {\n  const { variants, match } = createUnion(types)\n  variants.match = match\n  return variants\n}\n","/**\n * @typedef {import('./runtime').Send} Send\n * @typedef {import('./runtime').Message} Message\n * @typedef {Object} State\n * @typedef {() => State} GetState\n * @typedef {(send?: Send, getState?: GetState) => any} Effect\n */\n/**\n * Function to batch effects together.\n * @param {...Effect} effects\n * @return {(send?: Send, getState?: GetState) => void} Function\n */\nexport const batchEffects = (...effects) => (getState, send) =>\n  effects.map(effect => effect && effect(getState, send))\n\nexport const batch = batchEffects\n"],"names":["run","program","send","message","data","msg","isRunning","updateView","update","state","init","view","subscriptions","subs","done","isFirstRun","getState","hasOwnProperty","Object","prototype","match","tag","handlers","catchAll","type","call","console","error","dir","createUnion","types","variants","create","idx","length","union","batchEffects","effects","map","effect","batch"],"mappings":"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"}